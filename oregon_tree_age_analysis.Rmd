---
title: "Oregon Tree Age Analysis from LiDAR Data"
author: "Adams Geospatial"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

This document demonstrates how to calculate tree age from LiDAR-derived canopy height models using the Means & Sabin (1989) formula. The analysis tessellates the Siuslaw National Forest into 50-acre hexagons and calculates age statistics for each hexagon.

## Background

The Means & Sabin (1989) paper provides a formula to relate tree height, age, and site index for Douglas-fir in the Siuslaw National Forest. This relationship allows us to estimate tree age based on height measurements derived from LiDAR data.

## Required Packages

```{r libraries}
# Load required libraries
library(sf)          # For spatial data handling
library(terra)       # For raster operations
library(dplyr)       # For data manipulation
library(ForestTools) # For tree detection
library(ggplot2)     # For visualization
library(tmap)        # For mapping
library(units)       # For unit conversion

# Source the Oregon CHM downloader function
source("oregon_chm_downloader.R")

# Source our tree age calculator
source("oregon_tree_age_calculator.R")
```

# The Means & Sabin Formula

The Means & Sabin (1989) formula relates tree height, age, and site index. The site index (SI) is defined as the height of dominant trees at a reference age (usually 50 years).

```{r means_sabin_formula}
# Display the formula
calculate_site_index <- function(height, age) {
  # Parameters from Means & Sabin (1989)
  b0 <- 1.42956
  b1 <- 0.37900
  b2 <- 65.11
  b3 <- -0.022733
  b4 <- 1.27157

  # Compute Site Index (SI)
  SI <- 39.77 + (b0 / exp(age / 50) + b1 * exp(age / 300)) * 
        (height - b2 * (1 - exp(b3 * age))^b4)
  
  return(SI)
}

# Example: Compute SI for a tree that is 30m tall and 80 years old
tree_height <- 30  # meters
tree_age <- 80     # years
site_index <- calculate_site_index(tree_height, tree_age)

# Print result
cat("Estimated Site Index (SI):", round(site_index, 2), "meters\n")
```

## Estimating Age from Height

Since we have height data from LiDAR but need to estimate age, we need to invert the formula. We use an iterative approach to find the age that corresponds to a given height and site index.

```{r age_estimation_function}
# Display the age estimation function
estimate_age_from_height
```

# Creating a Hexagon Grid

We tessellate the Siuslaw National Forest into 50-acre hexagons. This size provides a good balance between spatial resolution and computational efficiency.

```{r hexagon_grid, eval=FALSE}
# Load National Forest boundaries
nf_path <- "Veg_ShapeFiles/FS_National_Forests_Dataset_(US_Forest_Service_Proclaimed_Forests)/FS_National_Forests_Dataset_(US_Forest_Service_Proclaimed_Forests).shp"
national_forests <- st_read(nf_path, quiet = TRUE)

# Filter for Siuslaw National Forest
siuslaw <- national_forests %>% 
  filter(FORESTNAME == "Siuslaw National Forest")

# Create hexagon grid (50 acres each)
hex_grid <- create_hexagon_grid(siuslaw, area_acres = 50)

# Plot the hexagon grid
plot(hex_grid$geometry, main = "Siuslaw National Forest - 50-acre Hexagons")
```

# Processing a Sample Hexagon

Let's demonstrate the process by analyzing a single hexagon:

```{r process_sample, eval=FALSE}
# Process the first hexagon
sample_hexagon <- hex_grid[1, ]
sample_result <- process_hexagon(sample_hexagon, 1)

# Display results
print(sample_result)
```

# Running the Full Analysis

The full analysis processes all hexagons in the Siuslaw National Forest. This can take several hours depending on the number of hexagons and the available computational resources.

```{r full_analysis, eval=FALSE}
# Run the full analysis
results <- run_tree_age_analysis()
```

# Visualizing Results

The analysis produces two main maps:

1. Tree Age Map: Shows the estimated mean age of trees in each hexagon
2. Tree Height Map: Shows the mean height of trees in each hexagon

```{r visualize_results, eval=FALSE}
# Load results if already computed
results <- st_read("output/siuslaw_tree_age.gpkg")

# Age map
age_map <- tm_shape(results) +
  tm_fill("mean_age", 
          title = "Mean Tree Age (years)",
          palette = "viridis",
          style = "cont") +
  tm_borders(col = "white", lwd = 0.1) +
  tm_layout(title = "Estimated Tree Age in Siuslaw National Forest",
            legend.position = c("right", "bottom"))

# Display map
age_map
```

# Conclusion

This analysis demonstrates how to estimate tree age from LiDAR-derived height data using the Means & Sabin (1989) formula. The results provide valuable information for forest management and conservation efforts in the Siuslaw National Forest.

# References

1. Means, J. E., & Sabin, T. E. (1989). Height growth and site index curves for Douglas-fir in the Siuslaw National Forest, Oregon. Western Journal of Applied Forestry, 4(4), 136-142.

2. McGaughey, R. J. (2018). FUSION/LDV: Software for LIDAR Data Analysis and Visualization. USDA Forest Service, Pacific Northwest Research Station.

3. Silva, C. A., Hudak, A. T., Vierling, L. A., Loudermilk, E. L., O'Brien, J. J., Hiers, J. K., ... & Khosravipour, A. (2016). Imputation of individual longleaf pine (Pinus palustris Mill.) tree attributes from field and LiDAR data. Canadian Journal of Remote Sensing, 42(5), 554-573. 